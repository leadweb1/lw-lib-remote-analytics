"use strict";var module,RemoteAnalytics;RemoteAnalytics={config:{apiUrl:"",socketUrl:"",deviceId:"device-id",deviceName:"device-name",deviceIp:"1.2.3.4",projectId:"project-id",pingInterval:60,doKeepAline:!0},sessions:[],token:null,socket:null,socketClientId:null,pingTimer:null,connected:!1,init:function(e,t){for(var i in e)e.hasOwnProperty(i)&&(this.config[i]=e[i]);this.socket=t,this.socket.on("connect",function(){RemoteAnalytics.connected=!0,this.token||RemoteAnalytics.login(function(e){void 0!==e.error?console.log(e.error):RemoteAnalytics.config.doKeepAline&&(RemoteAnalytics.ping(),RemoteAnalytics.pingTimer=setInterval(function(){RemoteAnalytics.ping()},1e3*RemoteAnalytics.config.pingInterval))})}),this.socket.on("socket-client-id",function(e){RemoteAnalytics.socketClientId=e.id}),this.socket.on("disconnect",function(){RemoteAnalytics.connected=!1,RemoteAnalytics.socket.emit("socket:disconnect",{device:RemoteAnalytics.socketClientId})})},mergeObjects:function(e,t){var i={};for(var s in e)e.hasOwnProperty(s)&&(i[s]=e[s]);for(var n in t)t.hasOwnProperty(n)&&(i[n]=t[n]);return i},getDate:function(){var e=new Date;return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()},ping:function(){this.socket.emit("socket:ping",{device:this.config.deviceId,socket:this.socketClientId})},apiRequest:function(e){if(this.connected){var t=new XMLHttpRequest;if(t.onreadystatechange=function(){if(4===t.readyState){var i=JSON.parse(t.responseText),s={};switch(t.status){case 200:s=RemoteAnalytics.mergeObjects(s,i);break;default:s.error=i.error}void 0!==e.callback&&e.callback(s)}},t.open(e.method,e.url),void 0!==e.headers)for(var i in e.headers)if(e.headers.hasOwnProperty(i)){var s=e.headers[i];t.setRequestHeader(i,s)}t.send(JSON.stringify(e.data))}else e.callback({error:"No connection available"})},getApiData:function(e,t){this.apiRequest({url:this.config.apiUrl+"/"+e,method:"GET",headers:{"X-AUTH-TOKEN":this.token,"Content-Type":"application/json"},callback:function(e){t(e)}})},login:function(e,t){void 0===t&&(t={}),this.apiRequest({url:this.config.apiUrl+"/login",method:"POST",data:this.mergeObjects({username:this.config.deviceName,password:this.config.authKey},t),headers:{"Content-Type":"application/json"},callback:function(t){if(void 0!==t.profile&&(RemoteAnalytics.token=t.profile.api_key,RemoteAnalytics.config.deviceId=t.profile.id,RemoteAnalytics.config.ip=t.ip,RemoteAnalytics.sessions.length>0))for(var i in RemoteAnalytics.sessions)RemoteAnalytics.sessions.hasOwnProperty(i)&&(RemoteAnalytics.sessions[i].ip=RemoteAnalytics.config.ip);e(t)}})},logAction:function(e){this.sessions.length<1&&this.submissionStart();var t=this.mergeObjects(e,{time:this.getDate()});return this.sessions[this.sessions.length-1].actions.push(t)},submissionStart:function(){var e={story:this.config.projectId,start_time:this.getDate(),end_time:0,ip:this.config.ip,actions:[]};this.sessions.push(e)},submissionEnd:function(e,t){return void 0===e&&(e=function(){}),void 0===t&&(t=function(){}),this.sessions.length<1?(this.sessions=[],void e()):(this.sessions[this.sessions.length-1].end_time=this.getDate(),void this.apiRequest({url:this.config.apiUrl+"/devices/"+this.config.deviceId,method:"POST",data:{sessions:this.sessions},headers:{"X-AUTH-TOKEN":this.token,"Content-Type":"application/json"},callback:function(e){e.error?(console.log(e.error),RemoteAnalytics.submissionStart()):RemoteAnalytics.sessions=[],t()}}))}},void 0!==module&&(module.exports=RemoteAnalytics);
//# sourceMappingURL=lib-remote-analytics.min.js.map